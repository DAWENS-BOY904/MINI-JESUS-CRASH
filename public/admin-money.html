<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Admin Money — Ledger</title>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
<style>
  body{font-family:Inter,system-ui;background:#071026;color:#eaf2ff;margin:0;padding:24px;display:flex;justify-content:center}
  .wrap{width:100%;max-width:1100px}
  h1{color:#6C63FF}
  .summary{display:flex;gap:16px;margin-top:12px;align-items:center}
  .card{background:rgba(255,255,255,0.03);padding:16px;border-radius:10px;border:1px solid rgba(255,255,255,0.02)}
  .ledger{margin-top:18px}
  table{width:100%;border-collapse:collapse}
  th,td{padding:10px;border-bottom:1px solid rgba(255,255,255,0.03);text-align:left}
  th{color:#9fb0d0;font-weight:600}
  .actions{display:flex;gap:10px}
  .btn{padding:8px 12px;border-radius:8px;border:none;cursor:pointer}
  .btn.primary{background:#6C63FF;color:#022;font-weight:700}
  .btn.warn{background:#FFAB00;color:#061018}
  .payout-form{margin-top:12px;display:flex;gap:8px;align-items:center}
  input[type="text"]{padding:8px;border-radius:8px;border:1px solid rgba(255,255,255,0.04);background:transparent;color:inherit}
</style>
</head>
<body>
  <main class="wrap">
    <h1>Admin Money Dashboard</h1>
    <div class="summary">
      <div class="card"><div>Total Received</div><div style="font-size:20px;font-weight:800;margin-top:6px" id="total">$0.00</div></div>
      <div class="card"><div>Pending Payouts</div><div style="font-size:20px;font-weight:800;margin-top:6px" id="pending">0</div></div>
      <div style="margin-left:auto" class="actions">
        <button class="btn primary" onclick="refresh()">Refresh</button>
      </div>
    </div>

    <section class="ledger">
      <h3 style="margin-top:18px">Transactions</h3>
      <table id="txTable"><thead><tr><th>ID</th><th>Payer</th><th>Plan</th><th>Amount</th><th>Status</th><th>Action</th></tr></thead><tbody></tbody></table>

      <div class="payout-form">
        <input id="dest" type="text" placeholder="Bank account / payout identifier (example: Stripe connected account id)" style="width:420px">
        <input id="amt" type="text" placeholder="Amount (e.g. 100.00)">
        <button class="btn warn" onclick="manualPayout()">Trigger Payout</button>
      </div>

      <p style="margin-top:12px;color:#9fb0d0">Note: This dashboard only displays ledger data from your server database. Actual bank transfers/payouts must be performed via your payment provider's secure API (Stripe/PayPal) or their dashboard after KYC verification.</p>
    </section>
  </main>

<script>
  async function refresh(){
    const res = await fetch('/api/admin/ledger', {credentials:'same-origin'});
    const json = await res.json();
    document.getElementById('total').textContent = '$' + (json.total || '0.00');
    document.getElementById('pending').textContent = json.pending || 0;
    const tbody = document.querySelector('#txTable tbody');
    tbody.innerHTML = '';
    (json.tx || []).forEach(t=>{
      const tr = document.createElement('tr');
      tr.innerHTML = `<td>${t.id}</td><td>${t.payer||'—'}</td><td>${t.plan||'—'}</td><td>${t.amount} ${t.currency||''}</td><td>${t.status}</td>
      <td><button class="btn" onclick="markPaid('${t.id}')">Mark Paid</button></td>`;
      tbody.appendChild(tr);
    });
  }
  async function manualPayout(){
    const dest = document.getElementById('dest').value;
    const amt = document.getElementById('amt').value;
    if(!dest || !amt){ alert('Provide destination and amount'); return; }
    const res = await fetch('/api/admin/payout', {
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body: JSON.stringify({destination:dest, amount:amt})
    });
    const j = await res.json();
    alert(j.ok ? 'Payout triggered (check provider dashboard).' : ('Error: ' + (j.error||'unknown')));
    refresh();
  }
  async function markPaid(id){
    const res = await fetch('/api/admin/mark-paid', {
      method:'POST', headers:{'Content-Type':'application/json'}, body: JSON.stringify({id})
    });
    const j = await res.json();
    alert(j.ok ? 'Marked' : ('Err: ' + (j.error||'')));
    refresh();
  }

  // load on open
  refresh();
</script>
</body>
</html>